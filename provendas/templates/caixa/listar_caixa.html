{% extends "template.html" %}

{% load static %}
{% block title %}
    Hístorico de vendas
{% endblock %}

{% block content %}

<style>
    .imagemProdutos{
      width: 11%;
      background: #fff;
      position: inherit;
      border: 1px solid rgba(52, 73, 94, 0.44);
      padding: 7px;
      border-radius: 50%;
    }

    .table td, .table th {
        vertical-align: middle !important;

    }

    .modal-body p {
        font-size: 1.2rem;
        margin-bottom: 1.2rem;
    }
    .modal-body ul {
        list-style: none;
        padding-left: 0;
    }
    .modal-body ul li {
        padding-left: 20px;
        position: relative;
    }
    .modal-body ul li i {
        position: absolute;
        left: 0;
        top: 0;
        font-size: 1.2rem;
    }
    
   
</style>

<div class="wrapper">
    {% include 'includes/sidebar.html' %}
    {% include 'includes/navbar.html' %} 

    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6 d-flex align-items-center">
                        <h1 class="mr-3"> Controle de Venda </h1> <!-- Adicionei a classe mr-3 -->
                        
                        <!-- Link para nova venda -->
                        <a href="{% url 'abrir_caixa_pdv' %}" class="btn btn-sm btn-success mr-2">
                            Nova Venda
                        </a>

                        <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#fecharCaixaModal" {% if not caixa_esta_aberto %}disabled{% endif %}>
                            Fechar Caixa
                        </button>
                        
                    </div>
                </div>
                
            </div><!-- /.container-fluid -->
        </section>
        
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <!-- Card de Pedidos -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Pesquisa</h3>
                            </div>
                            <div class="card-body table-responsive">
                                <div class="row mb-3">
                                    <!-- Campo de pesquisa -->
                                    <div class="col-12 col-sm-6 col-md-6">
                                        <div class="mb-3">
                                            <input type="text" id="searchInput" class="form-control" placeholder="Pesquisar por Pedido, Vendedor ou Cliente">
                                        </div>
                                    </div>
                                    
                                    <!-- Filtro por Status -->
                                    <div class="col-12 col-sm-6 col-md-3">
                                        <div class="mb-3">
                                            <select id="statusFilter" class="form-control">
                                                <option value="">Filtrar por Status</option>
                                                <option value="Em aberto">Em aberto</option>
                                                <option value="Finalizado">Finalizado</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtro por Vendedor -->
                                    <div class="col-12 col-sm-6 col-md-3">
                                        <div class="mb-3">
                                            <input type="text" id="vendedorFilter" class="form-control" placeholder="Filtrar por Vendedor">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-responsive py-3 text-center">
                                    <table id="orders" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th scope="col">Pedido</th>
                                                <th scope="col">Data/Hora</th>
                                                <th scope="col">Vendedor</th>
                                                <th scope="col">Cliente</th>
                                                <th scope="col">Total</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- As linhas de pedidos serão adicionadas aqui dinamicamente -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div id="pagination-controls" class="pagination text-center">
                                    <!-- Links de paginação serão injetados aqui -->
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        
      </div> 
         
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza de que deseja excluir este pedido?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Resultado -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Resultado da Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalMessageBody">
                Processando...
            </div>
        </div>
    </div>
</div>


<!-- Modal de Sucesso -->
<div class="modal fade" id="resultModal" tabindex="-1" role="dialog" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header justify-content-center">
                <!-- Ícone de confirmação com animação -->
                <div id="checkmark-animation" class="checkmark">
                    <div class="checkmark-circle"></div>
                    <div class="checkmark-stem"></div>
                    <div class="checkmark-kick"></div>
                </div>
            </div>
            <div class="modal-body text-center">
                <div class="modal-body text-center" id="modalMessageBody">
                    <!-- A mensagem será inserida aqui -->
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="modalCupomFiscal" tabindex="-1" role="dialog" aria-labelledby="modalCupomFiscalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title" id="modalCupomFiscalLabel"><i class="fas fa-receipt"></i> Detalhes do Cupom Fiscal</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modal-body-cupom">
                <!-- Detalhes serão preenchidos aqui via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal"><i class="fas fa-times"></i> Fechar</button>
                <button type="button" class="btn btn-primary btn-sm" id="gerar-cupom-btn"><i class="fas fa-print"></i> Gerar Cupom não Fiscal</button>
            </div>
        </div>
    </div>
</div>

<!--Modal de Fechar caixa-->
<div class="modal fade" id="fecharCaixaModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Fechar Caixa</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="fecharCaixaForm">
            <div class="form-group">
              <label for="saldoFinalInput">Saldo Final:</label>
              <input type="number" step="0.01" id="saldoFinalInput" class="form-control" value="0.00" required>
            </div>
            <button type="submit" class="btn btn-success btn-sm w-100">Fechar Caixa</button>
          </form>
        </div>
      </div>
    </div>
</div>  



{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function loadOrders(page = 1, searchTerm = '', statusFilter = '', vendedorFilter = '', clienteFilter = '') {
            $.ajax({
                url: '{% url "listar_pedidos_ajax" %}', // URL da view AJAX
                data: {
                    'page': page,
                    'search': searchTerm,
                    'status': statusFilter,
                    'vendedor': vendedorFilter,
                    'cliente': clienteFilter
                },
                success: function(response) {
                    var pedidos = response.pedidos;
                    var tbody = $("#orders tbody");
                    tbody.empty();
    
                    // Verifica se há pedidos para mostrar
                    if (pedidos.length === 0) {
                        tbody.append('<tr><td colspan="7" class="text-center">Nenhum pedido encontrado.</td></tr>');
                    } else {
                        pedidos.forEach(function(pedido) {
                            var row = `
                                <tr class="text-center">
                                    <td>#${pedido.numero_pedido}</td>
                                    <td>${pedido.data}</td>
                                    <td>${pedido.vendedor}</td>
                                    <td>${pedido.cliente}</td>
                                    <td><strong>R$ ${parseFloat(pedido.total).toFixed(2)}</strong></td>
                                    <td><span class="badge ${pedido.status === 'Em aberto' ? 'badge-warning' : 'badge-success'}">${pedido.status}</span></td>
                                    <td>
                                        <a href="{% url 'abrir_caixa_pdv' %}?id=${pedido.id}" class="btn btn-sm btn-success"><i class="fas fa-edit"></i></a>
                                        <a href="javascript:void(0);" class="btn btn-sm btn-primary" onclick="abrirModalCupomFiscal(${pedido.id})"><i class="fas fa-eye"></i></a>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="excluirVenda(${pedido.id})"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`;
                            tbody.append(row);
                        });
                    }
    
                    // Atualizar paginação
                    var paginationControls = $('#pagination-controls');
                    paginationControls.html('');
    
                    if (response.current_page > 1) {
                        paginationControls.append('<a href="javascript:void(0);" class="pagination-link btn btn-sm btn-success" data-page="1">Primeira Página</a>');
                        paginationControls.append('<a href="javascript:void(0);" class="pagination-link btn btn-sm btn-success" data-page="' + response.previous_page_number + '">Anterior</a>');
                    }
    
                    for (let i = 1; i <= response.total_pages; i++) {
                        paginationControls.append('<a href="javascript:void(0);" class="pagination-link btn btn-sm ' + (i === response.current_page ? 'btn-primary' : 'btn-light') + '" data-page="' + i + '">' + i + '</a>');
                    }
    
                    if (response.current_page < response.total_pages) {
                        paginationControls.append('<a href="javascript:void(0);" class="pagination-link btn btn-sm btn-warning" data-page="' + response.next_page_number + '">Próxima</a>');
                        paginationControls.append('<a href="javascript:void(0);" class="pagination-link btn btn-sm btn-warning" data-page="' + response.total_pages + '">Última Página</a>');
                    }
    
                    // Adicionar eventos aos links de paginação
                    $('.pagination-link').click(function() {
                        var page = $(this).data('page');
                        loadOrders(page, searchTerm, statusFilter, vendedorFilter, clienteFilter);
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar pedidos:", error);
                    alert("Erro ao carregar pedidos.");
                }
            });
        }
    
        // Eventos de busca e carregamento inicial
        $('#searchInput').on('input', function() {
            loadOrders(1, $(this).val(), $('#statusFilter').val(), $('#vendedorFilter').val(), $('#clienteFilter').val());
        });
    
        loadOrders(1);
    });
    
        
    // Função para excluir a venda
    window.excluirVenda = function(vendaId) {
        // Abre o modal de confirmação
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        confirmDeleteModal.show();
    
        // Manipulador do botão de confirmação
        document.getElementById('confirmDeleteButton').onclick = function() {
            fetch('/caixa/excluir_venda/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
                },
                body: JSON.stringify({ venda_id: vendaId })  // Passando o ID da venda aqui
            })
            .then(response => response.json())
            .then(data => {
                const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                const modalMessageBody = document.getElementById('modalMessageBody');
    
                if (data.success) {
                    modalMessageBody.textContent = data.message;
                    
                    // Remove a linha correspondente ao pedido da tabela
                    $('#pedido-' + vendaId).remove();  // Remover a linha pela ID da venda
                } else {
                    modalMessageBody.textContent = data.message;
                }
    
                // Exibe o modal de resultado
                resultModal.show();
    
                // Fecha o modal de confirmação
                confirmDeleteModal.hide();
    
                // Fecha automaticamente o modal de resultado após 3 segundos
                setTimeout(() => {
                    resultModal.hide();
                }, 3000);
            })
            .catch(error => {
                console.error('Erro ao excluir a venda:', error);
                const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                const modalMessageBody = document.getElementById('modalMessageBody');
                modalMessageBody.textContent = 'Erro ao excluir a venda. Por favor, tente novamente.';
                resultModal.show();
                confirmDeleteModal.hide();
    
                // Fecha automaticamente o modal de resultado após 3 segundos
                setTimeout(() => {
                    resultModal.hide();
                }, 3000);
            });
        };
    }
    
</script>

<!-- Sistema de visualização de produtos-->
<script>
    // Função para abrir a modal com os detalhes do pedido
    function abrirModalCupomFiscal(pedidoId) {
        $.ajax({
            url: '/caixa/cupom_fiscal_ajax/' + pedidoId + '/',  // Endpoint para carregar os dados da venda
            method: 'GET',
            success: function(response) {
                // Preencher a modal com os dados retornados
                var modalBody = $('#modal-body-cupom');
                modalBody.empty(); // Limpa o conteúdo anterior
    
                // Formatar valores com separador de milhar e vírgula para casas decimais
                const formatarMoeda = (valor) => {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
                };
    
                // Adiciona os detalhes do pedido com ícones
                modalBody.append('<p><i class="fas fa-file-alt"></i> <strong>Pedido:</strong> #' + response.numero_pedido + '</p>');
                modalBody.append('<p><i class="fas fa-user"></i> <strong>Cliente:</strong> ' + response.cliente + '</p>');
                modalBody.append('<p><i class="fas fa-tags"></i> <strong>Total:</strong> ' + formatarMoeda(response.total) + '</p>');
                modalBody.append('<p><i class="fas fa-check-circle"></i> <strong>Status:</strong> ' + response.status + '</p>');
    
                // Preenche os produtos em formato de tabela
                var produtosHtml = '<h5><i class="fas fa-cogs"></i> Produtos:</h5>';
                produtosHtml += '<table class="table table-striped table-bordered">';
                produtosHtml += '<thead><tr><th>#</th><th>Produto</th><th>Quantidade</th><th>Preço Unitário</th><th>Total</th></tr></thead>';
                produtosHtml += '<tbody>';
                
                var totalProdutos = 0;  // Variável para acumular o valor total dos produtos
    
                response.produtos.forEach(function(produto, index) {
                    var totalProduto = produto.quantidade * produto.preco_unitario; // Calcula o total por produto
                    totalProdutos += totalProduto; // Acumula o total
    
                    produtosHtml += '<tr>';
                    produtosHtml += '<td>' + (index + 1) + '</td>'; // Número de ordem
                    produtosHtml += '<td>' + produto.produto.nome + '</td>';
                    produtosHtml += '<td>' + produto.quantidade + '</td>';
                    produtosHtml += '<td>' + formatarMoeda(produto.preco_unitario) + '</td>';
                    produtosHtml += '<td>' + formatarMoeda(totalProduto) + '</td>';
                    produtosHtml += '</tr>';
                });
    
                // Adiciona a linha do total dos produtos
                produtosHtml += '</tbody>';
                produtosHtml += '<tfoot>';
                produtosHtml += '<tr><td colspan="4"><strong>Total Geral:</strong></td><td><strong>' + formatarMoeda(totalProdutos) + '</strong></td></tr>';
                produtosHtml += '</tfoot>';
                produtosHtml += '</table>';
    
                modalBody.append(produtosHtml);
    
                // Adicionar o evento de clique para gerar o cupom fiscal
                $('#gerar-cupom-btn').on('click', function() {
                    gerarCupomFiscal(pedidoId);
                });
    
                // Mostra a modal
                $('#modalCupomFiscal').modal('show');
            },
            error: function() {
                alert('Erro ao carregar os detalhes do cupom fiscal.');
            }
        });
    }
    

    // Função para gerar o cupom fiscal e abrir uma nova aba
    function gerarCupomFiscal(pedidoId) {
        // Abre a nova aba passando o ID do pedido na URL
        var cupomFiscalUrl = '/caixa/cupom_fiscal/' + pedidoId + '/';
        window.open(cupomFiscalUrl, '_blank');  // Abre em uma nova aba
    }


    document.getElementById('fecharCaixaForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Evita o envio padrão do formulário
    
        let saldoFinal = document.getElementById('saldoFinalInput').value;
    
        // Fazer a requisição AJAX para fechar o caixa
        fetch('/caixa/fechar_caixa_ajax/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // Enviando como JSON
                'X-CSRFToken': getCsrfToken() // Função para obter o CSRF token
            },
            body: JSON.stringify({ saldo_final: saldoFinal }) // Stringify os dados como JSON
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Caixa fechado com sucesso!');
                // Atualizar a página ou redirecionar
                location.reload();
            } else {
                alert('Erro ao fechar o caixa: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Ocorreu um erro ao tentar fechar o caixa.');
        });
    });
    
    // Função para obter o CSRF token (Django)
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
       
    
</script>



{% endblock %}

{% endblock %}
