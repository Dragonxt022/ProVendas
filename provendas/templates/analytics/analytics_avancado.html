{% extends "template.html" %}
{% load l10n %}

{% block title %}
    Analytic Avançado
{% endblock %}

{% block content %}
<div class="wrapper">
    {% include 'includes/sidebar.html' %}
    {% include 'includes/navbar.html' %} 
    <!-- Link para o CSS do Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        @media print {
           
            /* Esconder o formulário de pesquisa */
            form {
                display: none;
            }
    

        }
    </style>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <h1>Analytics Avançado</h1>
                    </div>
                    <div class="col-sm-5">

                        <button onclick="window.print()" class="btn btn-success btn-sm">Imprimir Relatório</button>
                    </div>
                </div>
            </div>
        </section>
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">

                                <form method="get" action="{% url 'filtro_relatorio_produtos' %}" class="mb-4">
                                    <div class="row">
                                        <!-- Selecionar Ano -->
                                        <div class="col-md-2 col-sm-12 mb-3">
                                            <select name="ano" id="ano" class="form-select form-control">
                                                <option value="">Selecione o Ano</option>
                                                {% for year in anos %}
                                                    <option value="{{ year }}" {% if year == ano|default:'' %}selected{% endif %}>{{ year }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                
                                        <!-- Selecionar Mês -->
                                        <div class="col-md-2 col-sm-12 mb-3">
                                            <select name="mes" id="mes" class="form-select form-control">
                                                <option value="">Selecione o Mês</option>
                                                {% for month in meses %}
                                                    <option value="{{ forloop.counter }}" {% if forloop.counter == mes|default:'' %}selected{% endif %}>{{ month }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                
                                        <!-- Selecionar Dia -->
                                        <div class="col-md-2 col-sm-12 mb-3">
                                            <select name="dia" id="dia" class="form-select form-control">
                                                <option value="">Selecione o Dia</option>
                                                {% for day in dias %}
                                                    <option value="{{ day }}" {% if day == dia|default:'' %}selected{% endif %}>{{ day }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                
                                        <!-- Selecionar Controle de Estoque -->
                                        <div class="col-md-3 col-sm-12 mb-3">
                                            <select name="controle_estoque" id="controle_estoque" class="form-select form-control">
                                                <option value="">Selecione o Controle de Estoque</option>
                                                <option value="True" {% if controle_estoque == 'True' %}selected{% endif %}>Com Estoque</option>
                                                <option value="False" {% if controle_estoque == 'False' %}selected{% endif %}>Sem Estoque</option>
                                                <option value="ambos" {% if controle_estoque == 'ambos' %}selected{% endif %}>Ambos</option>
                                            </select>
                                        </div>
                                
                                        <div class="col-md-3 col-sm-12 mb-3">
                                            <button type="submit" class="btn btn-success px-5 w-100">Filtrar Relatório</button>
                                        </div>
                                    </div>
                                </form>
                                
                                


                               <!-- Exibição de Dados -->
                                <table class="table table-striped table-bordered text-center">
                                    <thead class="bg-success">
                                        <tr>
                                            {% for coluna in colunas %}
                                                <th>{{ coluna }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for produto in produtos_dados %}
                                        <tr>
                                            <td>{{ produto.produto__nome }}</td>
                                            <td>{{ produto.quantidade_total }}</td>
                                            <td>{% localize on %}R$ {{ produto.produto__preco_de_custo|floatformat:2 }}{% endlocalize %}</td>
                                            <td>{% localize on %}R$ {{ produto.produto__preco_de_venda|floatformat:2 }}{% endlocalize %}</td>
                                            <td>{% localize on %}R$ {{ produto.valor_total|floatformat:2 }}{% endlocalize %}</td>
                                            <td>{% localize on %}R$ {{ produto.valor_bruto|floatformat:2 }}{% endlocalize %}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                                <div>
                                    <table class="table table-striped table-bordered text-center">
                                        <thead class="bg-success">
                                            <tr>
                                                <th>Total Bruto:</th>
                                                <th>Total Líquido:</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>R$ {{ total_bruto|floatformat:2 }}</strong></td>
                                                <td><strong>R$ {{ valor_liquido_total|floatformat:2 }}</strong></td>
                                            </tr> 
                                        </tbody>
                                    </table>
                                    <div class="row text-center">
                                        <div class="col">
                                            <p> 
                                                * O <strong>total Bruto</strong> é a soma total de todos os produtos vendidos  já removido os desconto se ouver das vendas. <br>
                                                * O <strong>total Líquido</strong> é a soma total entre o valor de custo e o valor de venda, trazendo o seu lucro de cada produto.    
                                            <p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card card-success card-outline">
                                    <div class="card-header">
                                        <h3 class="card-title">Relatório de Vendas por (Mês)</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <button type="button" class="btn btn-tool" data-card-widget="remove">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="bar-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card card-success card-outline">
                                    <div class="card-header">
                                        <h3 class="card-title">Produto com estoque Baixo</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <button type="button" class="btn btn-tool" data-card-widget="remove">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="estoqueBaixoChart"></canvas>
                                    </div>
                                </div>
                            </div>

                        </div> 
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card card-success card-outline">
                                    <div class="card-header">
                                        <h3 class="card-title">Produtos Mais vendidos Quantidade/Valor</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <button type="button" class="btn btn-tool" data-card-widget="remove">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="chartProdutos"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="card card-success card-outline">
                                    <div class="card-header">
                                        <h3 class="card-title">Principais Frormas de Pagamento</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <button type="button" class="btn btn-tool" data-card-widget="remove">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="payment-method-chart"></canvas>
                                    </div>
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
            </div>
        </section>


    </div>
</div>
{% block extra_scripts %}

<!-- Gráfico de Vendas por Mês -->
<script>
    var ctx = document.getElementById('bar-chart').getContext('2d');
    var barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ meses|safe }},  // Meses do ano
            datasets: [{
                label: 'Vendas por Mês',
                data: {{ vendas_mes|safe }},  // Dados de vendas por mês
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        // Configuração para formatar o eixo Y como R$
                        callback: function(value) {
                            // Utiliza a API Intl.NumberFormat para formatação de valores em reais
                            var formatter = new Intl.NumberFormat('pt-BR', {
                                style: 'currency',
                                currency: 'BRL'
                            });
                            return formatter.format(value);
                        }
                    }
                }
            }
        }
    });
</script>

<!-- Script para o Gráfico de Formas de Pagamento -->
<script>
    var ctx2 = document.getElementById('payment-method-chart').getContext('2d');
    var paymentChart = new Chart(ctx2, {
        type: 'pie',  // Gráfico de pizza
        data: {
            labels: {{ payment_methods|safe }},  // Formas de pagamento
            datasets: [{
                data: {{ payment_counts|safe }},  // Contagem de cada forma de pagamento
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],  // Cores para cada categoria
                hoverBackgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(tooltipItem) {
                            return tooltipItem.label + ': ' + tooltipItem.raw + ' vendas';
                        }
                    }
                }
            }
        }
    });
</script>

<!-- Gerenciar estoque baixo -->
<script>
    var produtosNomes = {{ produtos_nomes|safe }};
    var produtosQuantidades = {{ produtos_quantidades|safe }};

    var ctx = document.getElementById('estoqueBaixoChart').getContext('2d');
    var estoqueBaixoChart = new Chart(ctx, {
        type: 'bar', // Tipo de gráfico: barra
        data: {
            labels: produtosNomes, // Labels do eixo X
            datasets: [{
                label: 'Quantidade em Estoque',
                data: produtosQuantidades, // Dados do eixo Y
                backgroundColor: 'rgba(255, 99, 132, 0.2)', // Cor de fundo das barras
                borderColor: 'rgba(255, 99, 132, 1)', // Cor da borda das barras
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true // Começar o eixo Y em 0
                }
            }
        }
    });
</script>


<script>
    // Verifique se o Chart.js está carregado corretamente
    console.log(typeof Chart); // Deve mostrar "function"

    // Passando os dados como arrays diretamente
    var produtosNomes = {{ produtos_nomes|safe }};
    var produtosQuantidades = {{ produtos_quantidades|safe }};
    var produtosValores = {{ produtos_valores|safe }};

    // Gráfico de barras para quantidade de produtos vendidos e valor total
    var ctx = document.getElementById('chartProdutos').getContext('2d');
    var chartProdutos = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: produtosNomes,  // Nomes dos produtos
            datasets: [
                {
                    label: 'Quantidade Vendida',
                    data: produtosQuantidades,  // Dados de quantidade
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',  // Cor de fundo para as barras
                    borderColor: 'rgba(75, 192, 192, 1)',  // Cor da borda das barras
                    borderWidth: 1  // Largura da borda das barras
                },
                {
                    label: 'Valor Total Vendido (R$)',  // Rótulo para o segundo conjunto de dados
                    data: produtosValores,  // Dados do valor total vendido
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',  // Cor de fundo para as barras
                    borderColor: 'rgba(153, 102, 255, 1)',  // Cor da borda das barras
                    borderWidth: 1  // Largura da borda das barras
                }
            ]
        },
        options: {
            responsive: true,  // Tornar o gráfico responsivo
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true  // Garante que o gráfico comece do zero no eixo Y
                    }
                }]
            },
            legend: {
                position: 'top',  // Posição da legenda
                labels: {
                    fontSize: 14  // Tamanho da fonte das legendas
                }
            }
        }
    });
</script>



{% endblock %}
{% endblock %}
